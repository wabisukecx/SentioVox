# SentioVox: 感情分析音声合成システム

このプロジェクトは、テキストや音声の感情分析を行い、その結果に基づいて感情豊かな音声合成を実現するシステムです。解析された感情に応じて音声のパラメータを自動的に調整し、より自然で表現力豊かな音声出力を生成します。

## 機能

- 音声録音：高品質な音声入力の録音と保存
- 音声からのテキスト抽出：Whisperモデルを使用した高精度な音声認識
- テキストの感情分析：8つの基本感情（喜び、悲しみ、期待、驚き、怒り、恐れ、嫌悪、信頼）の検出と分析
- 感情に基づいた音声合成：分析結果に基づく自然な音声生成
- 音声ファイルのエクスポート：合成音声のM4A形式での保存機能

## 必要条件

- Python 3.8以上
- CUDA対応GPUを推奨（ない場合はCPUモードで動作）
- AIVISサーバー（localhost:10101で動作していることを想定）
- FFmpeg（音声ファイルの変換に使用）

## インストール

1. リポジトリをクローン:
```bash
git clone [リポジトリのURL]
cd SentioVox
```

2. 依存パッケージのインストール:
```bash
pip install -r requirements.txt
```

3. SpaCy日本語モデルのインストール:
```bash
python -m spacy download ja_ginza
```

4. FFmpegのインストール:
- Ubuntu/Debianの場合:
  ```bash
  sudo apt-get install ffmpeg
  ```
- macOSの場合:
  ```bash
  brew install ffmpeg
  ```
- Windowsの場合:
  1. FFmpegのダウンロード:
     - [FFmpeg公式ダウンロードページ](https://www.ffmpeg.org/download.html)にアクセス
     - 「Windows Builds」のリンクをクリック
     - gyan.dev のビルドから「ffmpeg-release-full.7z」をダウンロード
  2. インストール手順:
     - ダウンロードした7zファイルを展開（7-Zipが必要です）
     - 展開したフォルダ内の「bin」フォルダを見つける
     - このフォルダを任意の場所（例：C:\Program Files\FFmpeg）に移動
  3. 環境変数の設定:
     - Windowsキー + Rを押して「systempropertiesadvanced」と入力
     - 「環境変数」ボタンをクリック
     - システム環境変数の「Path」を選択して「編集」をクリック
     - 「新規」を選択し、FFmpegの binフォルダのパス（例：C:\Program Files\FFmpeg\bin）を追加
     - 「OK」を押して全ての画面を閉じる
  4. インストールの確認:
     - コマンドプロンプトを新しく開く
     - 以下のコマンドを実行してFFmpegが正しく認識されることを確認:
       ```bash
       ffmpeg -version
       ```

## 使用方法

### コマンドライン引数

- `--file`: 分析対象の音声/テキストファイルを指定
- `--record`: マイクから録音を開始
- `--duration`: 録音時間（秒）を指定
- `--speak`: 分析結果を音声合成で読み上げる
- `--output`: 合成音声をM4Aファイルとして保存（出力先を指定）
- `--no-play`: 音声の再生を無効化（保存のみ行う場合に使用）

### 使用例

1. テキストファイルを分析し、結果を音声で再生:
```bash
python -m src.main --file input.txt --speak
```

2. テキストを分析し、音声ファイルとして保存（再生なし）:
```bash
python -m src.main --file input.txt --speak --output output.m4a --no-play
```

3. マイクから録音して分析し、結果を音声ファイルとして保存:
```bash
python -m src.main --record --duration 15 --speak --output recording.m4a
```

4. 既存の音声ファイルを分析し、感情豊かな音声として再合成:
```bash
python -m src.main --file input.wav --speak --output enhanced.m4a
```

## プロジェクト構造

```
src/
├── __init__.py
├── audio/
│   ├── __init__.py
│   ├── recorder.py     # 音声録音
│   └── synthesis.py    # 音声合成
├── analysis/
│   ├── __init__.py
│   ├── emotion.py      # 感情分析
│   └── text.py         # テキスト処理
├── models/
│   ├── __init__.py
│   ├── voice.py        # 音声パラメータ
│   └── constants.py    # 定数定義
├── utils/
│   ├── __init__.py
│   └── warnings.py     # 警告抑制
└── main.py             # メインスクリプト
```

## 音声出力について

本システムは、分析結果に基づいて感情豊かな音声を生成し、以下の方法で出力できます：

1. リアルタイム再生：
   - `--speak`オプションを使用すると、合成音声をその場で再生します
   - 音声パラメータは検出された感情に基づいて自動調整されます

2. ファイル保存：
   - `--output`オプションで保存先を指定すると、M4A形式で音声を保存します
   - 高品質なAACエンコーディング（192kbps）を使用
   - ファイル名を指定しない場合は、タイムスタンプを含む自動生成名が使用されます

3. 再生制御：
   - `--no-play`オプションを使用すると、音声の再生を無効化できます
   - ファイル保存のみを行いたい場合に便利です

### 音声品質について

- サンプリングレート：24kHz（高品質な音声出力）
- エンコーディング：AAC（M4A形式、192kbps）
- チャンネル：モノラル（音声合成用に最適化）

## 注意事項

### 音声録音について
- 録音時は周囲の環境音に注意してください
- 録音中はCtrl+Cで中断可能です
- 録音データは一時ファイルとして保存され、処理後に自動的に削除されます

### 感情分析について
- 感情分析は8つの基本感情を検出します
- 感情スコアは0〜1の範囲で表示されます
- スコアが0.05未満の感情は表示されません

### 音声合成について
- AIVISサーバーが必要です（デフォルトでlocalhost:10101を使用）
- 感情に応じて音声パラメータが自動調整されます
- 複数の感情が検出された場合は、それらが自然に混合されます
- M4Aファイルへの変換にはFFmpegが必要です

## トラブルシューティング

### 一般的な問題

1. **音声ファイルの変換エラー**
   - FFmpegがインストールされていることを確認してください
   - M4A変換に失敗した場合、WAVファイルとして保存されます
   - FFmpegのパスが正しく設定されているか確認してください

2. **メモリ使用量に関する問題**
   - 長時間の音声処理時は自動的にバッチサイズが調整されます
   - メモリ不足の警告が表示された場合は、より短いセグメントに分けて処理することを推奨します

3. **AIVIS関連のエラー**
   - AIVISサーバーが起動していることを確認してください
   - サーバーのアドレスとポートが正しく設定されているか確認してください

### パフォーマンスの最適化

- バッチサイズは自動的に調整されますが、必要に応じて`models/constants.py`で手動調整も可能です
- GPU使用時は自動的に最適化されます
- キャッシュ機構により、同じテキストの重複分析を防いでいます

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細についてはLICENSEファイルを参照してください。

## 著者

- wabisuke - 初期開発者

## 謝辞

- Whisperチーム - 音声認識モデル
- SpaCyチーム - 自然言語処理ライブラリ
- AIVISチーム - 音声合成エンジン
- FFmpegプロジェクト - 音声フォーマット変換ツール