# SentioVox: 感情分析音声合成システム
テキストや音声の感情分析を行い、その結果に基づいて感情豊かな音声合成を実現するシステムです。

## 機能
- 音声録音: マイクからの音声入力
- 音声文字起こし: 音声ファイル(.mp3, .wav, .m4a, .flac)から日本語テキストを抽出
- 日本語テキスト：テキストファイル(.txt)を適切な文節に区切って感情分析用に下処理
- テキストの感情分析: 日本語テキストから8つの基本感情を分析
- 感情に基づいた音声合成: 分析結果に応じた感情表現豊かな音声を生成

## 必要条件
### システム要件
- Python 3.8以上
- CUDA対応GPUを推奨（ない場合はCPUモードで動作）
  - PyTorchは環境に応じてインストールしてください
    - CPU環境の場合: `pip install torch`
    - CUDA環境の場合: [PyTorch公式サイト](https://pytorch.org/get-started/locally/)で環境に合わせたインストールコマンドを確認してください
- FFmpeg
  - 音声ファイルの処理とフォーマット変換に必要です
  - 様々な音声フォーマット(.mp3, .wav, .m4a, .flac)の変換処理に使用されます
  - システムのPATH環境変数に追加する必要があります

### 必須ソフトウェア
- AivisSpeech
  - AivisSpeechをインストールすることで、音声合成エンジン（AivisSpeech-Engine）も同時にインストールされます
  - インストール後、音声合成エンジンが`C:\Program Files\AivisSpeech\AivisSpeech-Engine\run.exe`に配置されます
  - 音声合成機能を使用する際は、音声合成エンジンが起動している必要があります

## インストール
1. FFmpegのインストール
   1. [FFmpeg公式のGitHub Releases](https://github.com/BtbN/FFmpeg-Builds/releases)から最新の`ffmpeg-master-latest-win64-gpl.zip`をダウンロード
   2. ダウンロードしたZIPファイルを任意の場所（例：`C:\Program Files\FFmpeg`）に展開
   3. システムのPATH環境変数にFFmpegのbinフォルダを追加
      - Windowsキー + Rを押して「実行」ダイアログを開く
      - `sysdm.cpl`と入力してシステムのプロパティを開く
      - 「詳細設定」タブをクリック
      - 「環境変数」ボタンをクリック
      - 「システム環境変数」から「Path」を選択して「編集」をクリック
      - 「新規」をクリックし、FFmpegのbinフォルダのパス（例：`C:\Program Files\FFmpeg\bin`）を追加
      - すべてのダイアログで「OK」をクリック
   4. コマンドプロンプトを新しく開き、以下のコマンドでインストールを確認：
      ```bash
      ffmpeg -version
      ```
      バージョン情報が表示されれば、インストール成功です

2. AivisSpeechのインストール
   - AivisSpeechをインストールしてください
   - インストール後、音声合成エンジンが正しく配置されていることを確認してください

3. 依存パッケージのインストール:
```bash
pip install -r requirements.txt
```

4. SpaCy日本語モデルのインストール:
```bash
python -m spacy download ja_ginza
```

## 使用方法
### コマンドライン引数
- `--file`: テキストファイル(.txt)または音声ファイル(.mp3, .wav, .m4a, .flac)を指定
- `--record`: マイクから録音を開始
- `--duration`: 録音時間（秒）を指定
- `--speak`: 分析結果を音声合成で読み上げる

### 例
1. 音声ファイルから文字起こしと感情分析:
```bash
python -m src.main --file speech.wav
```

2. テキストファイルから感情分析:
```bash
python -m src.main --file input.txt
```

3. マイクから録音して文字起こしと感情分析:
```bash
python -m src.main --record --duration 15
```

4. 分析結果を音声合成で読み上げる:
```bash
python -m src.main --file speech.wav --speak
```

## プロジェクト構造
```
src/
├── __init__.py
├── audio/
│   ├── __init__.py
│   ├── recorder.py     # 音声録音
│   └── synthesis.py    # 音声合成
├── analysis/
│   ├── __init__.py
│   ├── emotion.py      # 感情分析
│   └── text.py         # テキスト処理
├── models/
│   ├── __init__.py
│   ├── voice.py        # 音声パラメータ
│   └── constants.py    # 定数定義
├── utils/
│   ├── __init__.py
│   ├── warnings.py     # 警告抑制
│   └── aivis_utils.py  # AIVISユーティリティ
└── main.py             # メインスクリプト
```

## ライセンス
このプロジェクトはMITライセンスの下で公開されています。

## 注意事項
### 音声録音について
- 録音時は周囲の環境音に注意してください
- 録音中はCtrl+Cで中断可能です
- 録音データは一時ファイルとして保存され、処理後に自動的に削除されます

### 感情分析について
- 感情分析は8つの基本感情（喜び、悲しみ、期待、驚き、怒り、恐れ、嫌悪、信頼）を検出します
- 感情スコアは0〜1の範囲で表示されます
- スコアが0.05未満の感情は表示されません

### 音声合成について
- AivisSpeechが必要です
- 音声合成機能を使用する際は、音声合成エンジンが起動している必要があります
- 感情に応じて音声パラメータが自動調整されます
- 複数の感情が検出された場合は、それらが混合されます

## トラブルシューティング
### FFmpeg関連の問題
1. **"ffmpegコマンドが見つかりません"というエラーが表示される**
   - コマンドプロンプトを開き、`ffmpeg -version`を実行して、FFmpegが正しく認識されているか確認してください
   - FFmpegのインストールフォルダが正しくPATH環境変数に追加されているか確認してください
   - コマンドプロンプトを再起動するか、PCを再起動してPATHの変更を反映させてください

2. **音声ファイルの変換でエラーが発生する**
   - FFmpegのインストールが正常に完了しているか確認してください
   - 入力する音声ファイルが破損していないか確認してください
   - システムに十分な空き容量があることを確認してください
   - エラーメッセージをコピーして保存し、詳細な状況と共に報告してください

### 音声合成に関する問題
1. **"AivisSpeech-Engineが見つかりません"**
   - AivisSpeechが正しくインストールされているか確認してください
   - インストールが必要な場合は、AivisSpeechをインストールしてください

2. **"音声合成エンジンは実行中ですが、応答がありません"**
   - AivisSpeechのメイン画面を開いて、音声合成エンジンを起動してください
   - ポート10101が他のプロセスで使用されていないか確認してください

3. **"音声合成エンジンの起動がタイムアウトしました"**
   - システムのリソース使用状況を確認してください
   - AivisSpeechを再起動してください

### 一般的な問題
1. **CUDA関連のエラー**
   - GPUが利用できない場合は自動的にCPUモードで動作します
   - CUDA関連の警告は自動的に抑制されます

2. **音声録音の問題**
   - マイクの接続を確認してください
   - PyAudioのインストールに問題がある場合は、OSに応じた追加ライブラリが必要な場合があります

### パフォーマンスの最適化
- バッチサイズは`models/constants.py`で調整可能です
- GPU使用時は自動的に最適化されます
- キャッシュ機構により、同じテキストの重複分析を防いでいます

## 著者
- wabisuke - 初期開発者

## 謝辞
- Whisperチーム - 音声認識モデル
- SpaCyチーム - 自然言語処理ライブラリ
- GiNZAチーム - 日本語自然言語処理ライブラリ
- AIVISチーム - 音声合成エンジン
- koshin2001 - 日本語感情分析モデル (https://huggingface.co/koshin2001/Japanese-to-emotions)
